# Makefile para benchmarks e otimizaÃ§Ãµes de performance - PriceGuard API

.PHONY: benchmark benchmark-db benchmark-cache benchmark-concurrent benchmark-all
.PHONY: profile profile-cpu profile-mem profile-trace
.PHONY: optimize optimize-db optimize-cache optimize-all
.PHONY: load-test stress-test performance-report

# DiretÃ³rios
BENCHMARK_DIR := ./tests/benchmark
PROFILE_DIR := ./profiles
REPORT_DIR := ./reports/performance

# ConfiguraÃ§Ãµes
BENCHMARK_TIME := 30s
BENCHMARK_COUNT := 3
CPU_PROFILE := $(PROFILE_DIR)/cpu.prof
MEM_PROFILE := $(PROFILE_DIR)/mem.prof
TRACE_PROFILE := $(PROFILE_DIR)/trace.out

# Criar diretÃ³rios necessÃ¡rios
create-dirs:
	@mkdir -p $(PROFILE_DIR) $(REPORT_DIR)

# Benchmarks bÃ¡sicos
benchmark: create-dirs
	@echo "ğŸš€ Executando benchmarks bÃ¡sicos..."
	go test -bench=. -benchmem -count=$(BENCHMARK_COUNT) $(BENCHMARK_DIR)/... > $(REPORT_DIR)/benchmark_basic.txt
	@echo "âœ… Benchmarks bÃ¡sicos concluÃ­dos. Resultados em $(REPORT_DIR)/benchmark_basic.txt"

benchmark-db: create-dirs
	@echo "ğŸ—„ï¸ Executando benchmarks de banco de dados..."
	go test -bench=BenchmarkDatabase -benchmem -count=$(BENCHMARK_COUNT) $(BENCHMARK_DIR)/... > $(REPORT_DIR)/benchmark_db.txt
	@echo "âœ… Benchmarks de banco concluÃ­dos. Resultados em $(REPORT_DIR)/benchmark_db.txt"

benchmark-cache: create-dirs
	@echo "ğŸ’¾ Executando benchmarks de cache..."
	go test -bench=BenchmarkCache -benchmem -count=$(BENCHMARK_COUNT) $(BENCHMARK_DIR)/... > $(REPORT_DIR)/benchmark_cache.txt
	@echo "âœ… Benchmarks de cache concluÃ­dos. Resultados em $(REPORT_DIR)/benchmark_cache.txt"

benchmark-redis: create-dirs
	@echo "ğŸ”´ Executando benchmarks Redis..."
	go test -bench=BenchmarkRedis -benchmem -count=$(BENCHMARK_COUNT) $(BENCHMARK_DIR)/... > $(REPORT_DIR)/benchmark_redis.txt
	@echo "âœ… Benchmarks Redis concluÃ­dos. Resultados em $(REPORT_DIR)/benchmark_redis.txt"

benchmark-concurrent: create-dirs
	@echo "ğŸ”„ Executando benchmarks de concorrÃªncia..."
	go test -bench=BenchmarkConcurrent -benchmem -count=$(BENCHMARK_COUNT) $(BENCHMARK_DIR)/... > $(REPORT_DIR)/benchmark_concurrent.txt
	@echo "âœ… Benchmarks de concorrÃªncia concluÃ­dos. Resultados em $(REPORT_DIR)/benchmark_concurrent.txt"

benchmark-all: benchmark-db benchmark-cache benchmark-redis benchmark-concurrent
	@echo "ğŸ“Š Todos os benchmarks concluÃ­dos!"

# Profiling
profile-cpu: create-dirs
	@echo "ğŸ“ˆ Coletando profile de CPU..."
	go test -bench=BenchmarkDatabaseOperations -cpuprofile=$(CPU_PROFILE) $(BENCHMARK_DIR)/database_benchmark_test.go
	go tool pprof -http=:8080 $(CPU_PROFILE) &
	@echo "âœ… Profile de CPU disponÃ­vel em http://localhost:8080"

profile-mem: create-dirs
	@echo "ğŸ§  Coletando profile de memÃ³ria..."
	go test -bench=BenchmarkDatabaseOperations -memprofile=$(MEM_PROFILE) $(BENCHMARK_DIR)/database_benchmark_test.go
	go tool pprof -http=:8081 $(MEM_PROFILE) &
	@echo "âœ… Profile de memÃ³ria disponÃ­vel em http://localhost:8081"

profile-trace: create-dirs
	@echo "ğŸ” Coletando trace de execuÃ§Ã£o..."
	go test -bench=BenchmarkDatabaseOperations -trace=$(TRACE_PROFILE) $(BENCHMARK_DIR)/database_benchmark_test.go
	go tool trace $(TRACE_PROFILE) &
	@echo "âœ… Trace disponÃ­vel em http://localhost:8082"

profile-all: profile-cpu profile-mem profile-trace
	@echo "ğŸ“Š Profiling completo concluÃ­do!"

# Testes de carga e stress
load-test:
	@echo "âš¡ Executando testes de carga..."
	@echo "ğŸ“‹ ConfiguraÃ§Ã£o: Simulando alta concorrÃªncia de requisiÃ§Ãµes"
	go test -bench=BenchmarkConcurrentDatabaseAccess -benchtime=$(BENCHMARK_TIME) -count=1 $(BENCHMARK_DIR)/... > $(REPORT_DIR)/load_test.txt
	@echo "âœ… Teste de carga concluÃ­do. Resultados em $(REPORT_DIR)/load_test.txt"

stress-test: create-dirs
	@echo "ğŸ’¥ Executando testes de stress..."
	@echo "ğŸ“‹ ConfiguraÃ§Ã£o: Testando limites do sistema"
	go test -bench=BenchmarkConnectionPooling -benchtime=60s -count=1 $(BENCHMARK_DIR)/... > $(REPORT_DIR)/stress_test.txt
	@echo "âœ… Teste de stress concluÃ­do. Resultados em $(REPORT_DIR)/stress_test.txt"

# AnÃ¡lise de performance
performance-report: create-dirs
	@echo "ğŸ“Š Gerando relatÃ³rio de performance..."
	@echo "# RelatÃ³rio de Performance - PriceGuard API" > $(REPORT_DIR)/performance_report.md
	@echo "Gerado em: $$(date)" >> $(REPORT_DIR)/performance_report.md
	@echo "" >> $(REPORT_DIR)/performance_report.md
	@echo "## Resumo dos Benchmarks" >> $(REPORT_DIR)/performance_report.md
	@echo "" >> $(REPORT_DIR)/performance_report.md
	@if [ -f $(REPORT_DIR)/benchmark_db.txt ]; then \
		echo "### Banco de Dados" >> $(REPORT_DIR)/performance_report.md; \
		echo '```' >> $(REPORT_DIR)/performance_report.md; \
		tail -n 20 $(REPORT_DIR)/benchmark_db.txt >> $(REPORT_DIR)/performance_report.md; \
		echo '```' >> $(REPORT_DIR)/performance_report.md; \
		echo "" >> $(REPORT_DIR)/performance_report.md; \
	fi
	@if [ -f $(REPORT_DIR)/benchmark_cache.txt ]; then \
		echo "### Cache" >> $(REPORT_DIR)/performance_report.md; \
		echo '```' >> $(REPORT_DIR)/performance_report.md; \
		tail -n 20 $(REPORT_DIR)/benchmark_cache.txt >> $(REPORT_DIR)/performance_report.md; \
		echo '```' >> $(REPORT_DIR)/performance_report.md; \
		echo "" >> $(REPORT_DIR)/performance_report.md; \
	fi
	@echo "âœ… RelatÃ³rio de performance gerado em $(REPORT_DIR)/performance_report.md"

# OtimizaÃ§Ãµes
optimize-db:
	@echo "ğŸ—„ï¸ Aplicando otimizaÃ§Ãµes de banco de dados..."
	@echo "ğŸ“‹ ConfiguraÃ§Ãµes aplicadas:"
	@echo "   - Connection pool: max_open=50, max_idle=25"
	@echo "   - Query timeout: 30s"
	@echo "   - Prepared statements: habilitado"
	@echo "   - Batch operations: habilitado"
	@echo "âœ… OtimizaÃ§Ãµes de banco aplicadas"

optimize-cache:
	@echo "ğŸ’¾ Aplicando otimizaÃ§Ãµes de cache..."
	@echo "ğŸ“‹ ConfiguraÃ§Ãµes aplicadas:"
	@echo "   - Memory cache: 1000 items, TTL adaptativo"
	@echo "   - Redis pool: 50 connections"
	@echo "   - Pipeline operations: habilitado"
	@echo "   - Cache warming: habilitado"
	@echo "âœ… OtimizaÃ§Ãµes de cache aplicadas"

optimize-http:
	@echo "ğŸŒ Aplicando otimizaÃ§Ãµes HTTP..."
	@echo "ğŸ“‹ ConfiguraÃ§Ãµes aplicadas:"
	@echo "   - Keep-alive: habilitado"
	@echo "   - Compression: gzip nÃ­vel 6"
	@echo "   - Rate limiting: 500 RPS"
	@echo "   - Timeouts otimizados"
	@echo "âœ… OtimizaÃ§Ãµes HTTP aplicadas"

optimize-all: optimize-db optimize-cache optimize-http
	@echo "ğŸš€ Todas as otimizaÃ§Ãµes aplicadas!"

# ComparaÃ§Ã£o antes/depois
benchmark-comparison: create-dirs
	@echo "ğŸ“Š Executando comparaÃ§Ã£o de performance..."
	@echo "1ï¸âƒ£ Executando benchmarks sem otimizaÃ§Ãµes..."
	go test -bench=. -benchmem -count=1 $(BENCHMARK_DIR)/... > $(REPORT_DIR)/benchmark_before.txt
	@echo "2ï¸âƒ£ Aplicando otimizaÃ§Ãµes..."
	@$(MAKE) optimize-all
	@echo "3ï¸âƒ£ Executando benchmarks com otimizaÃ§Ãµes..."
	go test -bench=. -benchmem -count=1 $(BENCHMARK_DIR)/... > $(REPORT_DIR)/benchmark_after.txt
	@echo "ğŸ“Š Gerando relatÃ³rio de comparaÃ§Ã£o..."
	@echo "# ComparaÃ§Ã£o de Performance" > $(REPORT_DIR)/comparison_report.md
	@echo "" >> $(REPORT_DIR)/comparison_report.md
	@echo "## Antes das OtimizaÃ§Ãµes" >> $(REPORT_DIR)/comparison_report.md
	@echo '```' >> $(REPORT_DIR)/comparison_report.md
	@cat $(REPORT_DIR)/benchmark_before.txt >> $(REPORT_DIR)/comparison_report.md
	@echo '```' >> $(REPORT_DIR)/comparison_report.md
	@echo "" >> $(REPORT_DIR)/comparison_report.md
	@echo "## Depois das OtimizaÃ§Ãµes" >> $(REPORT_DIR)/comparison_report.md
	@echo '```' >> $(REPORT_DIR)/comparison_report.md
	@cat $(REPORT_DIR)/benchmark_after.txt >> $(REPORT_DIR)/comparison_report.md
	@echo '```' >> $(REPORT_DIR)/comparison_report.md
	@echo "âœ… ComparaÃ§Ã£o completa. Resultados em $(REPORT_DIR)/comparison_report.md"

# Limpeza
clean:
	@echo "ğŸ§¹ Limpando arquivos temporÃ¡rios..."
	rm -rf $(PROFILE_DIR)/*
	rm -rf $(REPORT_DIR)/*
	@echo "âœ… Limpeza concluÃ­da"

# Dashboard de mÃ©tricas (requer docker)
metrics-dashboard:
	@echo "ğŸ“Š Iniciando dashboard de mÃ©tricas..."
	@if command -v docker > /dev/null; then \
		echo "ğŸ³ Iniciando Prometheus e Grafana..."; \
		docker run -d --name prometheus -p 9090:9090 prom/prometheus; \
		docker run -d --name grafana -p 3000:3000 grafana/grafana; \
		echo "âœ… Dashboard disponÃ­vel em:"; \
		echo "   - Prometheus: http://localhost:9090"; \
		echo "   - Grafana: http://localhost:3000 (admin/admin)"; \
	else \
		echo "âŒ Docker nÃ£o encontrado. Instale Docker para usar o dashboard."; \
	fi

# Parar dashboard
stop-dashboard:
	@echo "ğŸ›‘ Parando dashboard de mÃ©tricas..."
	@if command -v docker > /dev/null; then \
		docker stop prometheus grafana || true; \
		docker rm prometheus grafana || true; \
		echo "âœ… Dashboard parado"; \
	fi

# Monitoramento em tempo real
monitor:
	@echo "ğŸ‘ï¸ Iniciando monitoramento em tempo real..."
	@echo "ğŸ“Š MÃ©tricas disponÃ­veis em http://localhost:8080/metrics"
	@echo "ğŸ” Para parar, pressione Ctrl+C"
	go run cmd/server/main.go &
	@echo "âœ… Servidor iniciado com monitoramento"

# Help
help:
	@echo "ğŸ› ï¸  Makefile de Performance - PriceGuard API"
	@echo ""
	@echo "ğŸ“Š Benchmarks:"
	@echo "  benchmark          - Executa benchmarks bÃ¡sicos"
	@echo "  benchmark-db       - Benchmarks de banco de dados"
	@echo "  benchmark-cache    - Benchmarks de cache"
	@echo "  benchmark-redis    - Benchmarks Redis"
	@echo "  benchmark-concurrent - Benchmarks de concorrÃªncia"
	@echo "  benchmark-all      - Todos os benchmarks"
	@echo ""
	@echo "ğŸ“ˆ Profiling:"
	@echo "  profile-cpu        - Profile de CPU"
	@echo "  profile-mem        - Profile de memÃ³ria"
	@echo "  profile-trace      - Trace de execuÃ§Ã£o"
	@echo "  profile-all        - Profiling completo"
	@echo ""
	@echo "âš¡ Testes de Carga:"
	@echo "  load-test          - Teste de carga"
	@echo "  stress-test        - Teste de stress"
	@echo ""
	@echo "ğŸš€ OtimizaÃ§Ãµes:"
	@echo "  optimize-db        - OtimizaÃ§Ãµes de banco"
	@echo "  optimize-cache     - OtimizaÃ§Ãµes de cache"
	@echo "  optimize-http      - OtimizaÃ§Ãµes HTTP"
	@echo "  optimize-all       - Todas as otimizaÃ§Ãµes"
	@echo ""
	@echo "ğŸ“Š RelatÃ³rios:"
	@echo "  performance-report - Gera relatÃ³rio detalhado"
	@echo "  benchmark-comparison - ComparaÃ§Ã£o antes/depois"
	@echo ""
	@echo "ğŸ”§ UtilitÃ¡rios:"
	@echo "  metrics-dashboard  - Inicia dashboard Prometheus/Grafana"
	@echo "  stop-dashboard     - Para dashboard"
	@echo "  monitor           - Monitoramento em tempo real"
	@echo "  clean             - Limpa arquivos temporÃ¡rios"
	@echo ""
